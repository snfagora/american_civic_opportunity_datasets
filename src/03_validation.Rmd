---
title: "Validation"
author: "Jae Yeon Kim"
date: "`r Sys.Date()`"
output: html_document
---

# Import pkgs 

```{r}
if (!require(pacman)) install.packages("pacman")

pacman::p_load(
  broom, 
  tidyverse,
  glue,
  here,
  purrr,
  estimatr,
  effectsize,
  sandwich,
  ggrepel,
  patchwork,
  ggpubr, 
  corrplot,
  corrr,
  correlation, 
  tidycensus,
  callr,
  naniar,
  modelsummary,
  confintr, 
  tinytable, 
  vroom, 
  gt,
  DT,
  sf,
  tigris,
  statebins,
  RColorBrewer
)
```

```{r}

library("tidylog", warn.conflicts = FALSE)

devtools::install_github("graemeblair/stdidx")
library(stdidx)

options(es.use_symbols = TRUE) # get nice symbols

source(here("functions", "utils.r"))

ggplot2::theme_set(custom_theme())
```

# Import data 

```{r}
# MMA data 
## master file 
mbf <- vroom(here("raw_data", "irs_mbf.csv"))

## org activities from the websites and elsewhere 
org_activities <- vroom(here("raw_data", "irs_org_activities.csv"))

irs_activities <- vroom(here("raw_data","irs_nonweb_activities.csv"))

irs_activities <- irs_activities %>%
  replace_na(list(volunteer_text = 0, member_text = 0)) # without this, the following mutate won't work

## prediction labels
irs_pred <- vroom(here("raw_data", "predictions.csv")) %>%
  select(ein, predicted)
```

```{r}
## PO BOX status
po_status <- read_csv(here("raw_data", "irs_po_status.csv"))

## orgs geolocated to FIPS
irs_to_fips <- vroom(here("raw_data", "irs_to_fips.csv"))
```

"HCOST" = "Housing cost burden among households" 
"POV150" = Persons living below 150% of the poverty level
"CROWD" = "Crowding among housing units"
"AGE65" = "Persons aged 65 years or older"     
"SNGPNT" = "Single-parent households"
"BROAD" = "No broadband internet subscription among households"
"NOHSDP" = "No high school diploma among adults aged 25 years or older" 
"UNEMP" = "Unemployment among people 16 years and older in the labor force"
"REMNRTY" = "Persons of racial or ethnic minority status"

```{r}
# SDOH (2017-2021 ACS adapted by CDC)

## County 
sdoh_county <- read_csv(here("raw_data", "sdoh_county.csv"))

sdoh_county <- sdoh_county %>%
  select(StateAbbr, StateDesc, LocationID, MeasureID, Data_Value, TotalPopulation, Geolocation)

sdoh_county_wide <- sdoh_county %>%
  pivot_wider(names_from = MeasureID, 
              values_from = Data_Value)

## Zipcode
sdoh_zcta <- read_csv(here("raw_data", "sdoh_zcta.csv")) 

sdoh_zcta <- sdoh_zcta %>%
  select(LocationName, MeasureID, Data_Value, TotalPopulation, Geolocation)

sdoh_zcta_wide <- sdoh_zcta %>%
  pivot_wider(names_from = MeasureID, 
              values_from = Data_Value)
```


# Description

```{r}
# County 
datasummary(civic_org_sum_normalized + volunteer_sum_normalized + membership_sum_normalized + take_action_sum_normalized + events_sum_normalized ~ mean_no_na + std_no_na, 
            data = cnts_counts_cov, 
            output = "tinytable",
            fmt = 2) %>%
  save_tt(
    here("tables", "county_civic_opp_table.tex"),
    overwrite = TRUE
    )

# ZCTA
datasummary(civic_org_sum_normalized + volunteer_sum_normalized + membership_sum_normalized + take_action_sum_normalized + events_sum_normalized ~ mean_no_na + std_no_na, 
            data = zcta_counts_cov,
            output = "tinytable",
            fmt = 2) %>%
  save_tt(
    here("tables", "zcta_civic_opp_table.tex"),
    overwrite = TRUE
    )
```

```{r}
cnts_state_avg_se <- cnts_counts_cov %>%
  group_by(state) %>%
  summarize(avg = mean_no_na(civic_opp_index),
            se = std_no_na(civic_opp_index)) %>%
  mutate(unit = "County")

zcta_state_avg_se <- zcta_counts_cov %>%
  group_by(state) %>%
  summarize(avg = mean_no_na(civic_opp_index),
            se = std_no_na(civic_opp_index)) %>%
  mutate(unit = "Zipcode")
```

```{r}
bind_rows(cnts_state_avg_se, zcta_state_avg_se) %>%
  ggplot(aes(x = fct_reorder(state, avg), y = avg, ymax = avg + 1.96*se, ymin = avg - 1.96*se, fill = unit)) +
  geom_col(position = position_dodge()) +
  geom_errorbar(position = position_dodge()) +
  coord_flip() +
  labs(x = "",
       y = "Average civic opportunity index (1-5)",
       fill = "Aggregation unit")

ggsave(here("plots", "civic_opp_index_plots.png"))
```

```{r}

```

# Validation [TBD]

"HCOST" = "Housing cost burden among households" 
"POV150" = Persons living below 150% of the poverty level
"CROWD" = "Crowding among housing units"
"AGE65" = "Persons aged 65 years or older"     
"SNGPNT" = "Single-parent households"
"BROAD" = "No broadband internet subscription among households"
"NOHSDP" = "No high school diploma among adults aged 25 years or older" 
"UNEMP" = "Unemployment among people 16 years and older in the labor force"
"REMNRTY" = "Persons of racial or ethnic minority status"

```{r}
corr_mod <- dd %>%
  # group_by(State) %>%
  do(tidy(standardize(lm_robust(formula = opc ~ race_per_white_nonhispanic + per_poverty + college_educ, data = .)))) # Here standardize refers to refitting the model with standardized data (https://cran.r-project.org/web/packages/effectsize/vignettes/effectsize.html) z-scoring

corr_mod_rc <- dd %>%
  # group_by(State) %>%
  do(tidy(standardize(lm_robust(formula = all_org ~ race_per_white_nonhispanic + per_poverty + college_educ, data = .))))
```

```{r}
corr_mod_bind <- bind_rows(
  mutate(corr_mod, DV = "Civic opportunity index"),
  mutate(corr_mod_rc, DV = "Organizational density")
)

pred_plot <- corr_mod_bind %>%
  mutate(term = recode(term,
    "race_per_white_nonhispanic" = "Non-hispanic white",
    "per_poverty" = "Federal poverty level",
    "college_educ" = "College educated"
  )) %>%
  filter(!str_detect(term, "(Intercept)")) %>%
  ggplot(aes(x = term)) +
  geom_text_repel(aes(y = estimate, label = round(estimate, 2), fill = DV, size = 1.5),
    position = position_dodge(width = 0.9),
    col = "black",
    show.legend = FALSE
  ) +
  geom_col(aes(y = estimate, fill = DV), position = "dodge", alpha = 0.4) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error, fill = DV), position = "dodge", alpha = 0.4) +
  geom_hline(yintercept = 0, linetype = "dashed", col = "red") +
  labs(
    x = "Predictors",
    y = "Estimated regression coefficient",
    fill = "Response variables"
  ) +
  scale_fill_viridis_d(begin = 0.1, end = 0.9) +
  # facet_wrap(~term, ncol = 2) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  coord_flip() +
  theme(legend.position = "bottom")

pred_plot

ggsave(here("outputs", "pred_plot.png"), height = 6, width = 6)
```