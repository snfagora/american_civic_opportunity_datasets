---
title: "Validation"
author: "Jae Yeon Kim"
date: "`r Sys.Date()`"
output: html_document
---

# Import pkgs 

```{r}
if (!require(pacman)) install.packages("pacman")

pacman::p_load(
  broom, 
  tidyverse,
  glue,
  here,
  purrr,
  estimatr,
  effectsize,
  sandwich,
  ggrepel,
  patchwork,
  ggpubr, 
  corrplot,
  corrr,
  correlation, 
  tidycensus,
  callr,
  naniar,
  modelsummary,
  confintr, 
  tinytable, 
  vroom, 
  gt,
  DT,
  sf,
  tigris,
  statebins,
  RColorBrewer
)

library("tidylog", warn.conflicts = FALSE)

devtools::install_github("graemeblair/stdidx")
library(stdidx)

options(es.use_symbols = TRUE) # get nice symbols

source(here("functions", "utils.r"))

ggplot2::theme_set(custom_theme())
```

# Import data 

```{r}
# County 
cnts_counts_cov <- read_csv(here("data_outputs", "county_counts_cov.csv"))

# Zipcode
zcta_counts_cov <- read_csv(here("data_outputs", "zcta_counts_cov.csv"))
```

# Preprocessing 

```{r}
# County 
cnts_counts_cov <- cnts_counts_cov %>%
  select(HCOST, POV150, CROWD, AGE65, SNGPNT, BROAD, NOHSDP, UNEMP, REMNRTY) %>%
  mutate(HCOST = normalize(HCOST), 
         POV150 = normalize(POV150),
         CROWD = normalize(CROWD),
         AGE65 = normalize(AGE65),
         SNGPNT = normalize(SNGPNT),
         BROAD = normalize(BROAD),
         NOHSDP = normalize(NOHSDP),
         UNEMP = normalize(UNEMP),
         REMNRTY = normalize(REMNRTY))

# Zipcode
zcta_counts_cov <- zcta_counts_cov %>%
  select(HCOST, POV150, CROWD, AGE65, SNGPNT, BROAD, NOHSDP, UNEMP, REMNRTY) %>%
  mutate(HCOST = normalize(HCOST), 
         POV150 = normalize(POV150),
         CROWD = normalize(CROWD),
         AGE65 = normalize(AGE65),
         SNGPNT = normalize(SNGPNT),
         BROAD = normalize(BROAD),
         NOHSDP = normalize(NOHSDP),
         UNEMP = normalize(UNEMP),
         REMNRTY = normalize(REMNRTY))
```

# Validation [TBD]

"HCOST" = "Housing cost burden among households" 
"POV150" = "Persons living below 150% of the poverty level"
"CROWD" = "Crowding among housing units"
"AGE65" = "Persons aged 65 years or older"     
"SNGPNT" = "Single-parent households"
"BROAD" = "No broadband internet subscription among households"
"NOHSDP" = "No high school diploma among adults aged 25 years or older" 
"UNEMP" = "Unemployment among people 16 years and older in the labor force"
"REMNRTY" = "Persons of racial or ethnic minority status"

```{r}
# County 

wrap_plots(
  cnty_pred_plot(POV150, "Persons living below 150% of the poverty level"), # poverty
  cnty_pred_plot(NOHSDP, "No high school diploma among adults aged 25 years or older"), # college education
  cnty_pred_plot(REMNRTY, "Persons of racial or ethnic minority status"), # race
  cnty_pred_plot(AGE65, "Persons aged 65 years or older"), # age
  cnty_pred_plot(SNGPNT, "Single-parent households"), # household conditions 
  cnty_pred_plot(UNEMP, "Unemployment among people 16 years and older in the labor force"), # household conditions 
   # infrastructure 
  cnty_pred_plot(HCOST, "Housing cost burden among households"), # housing conditions 
  cnty_pred_plot(CROWD, "Crowding among housing units"), # housing conditions 
  cnty_pred_plot(BROAD, "No broadband internet subscription among households"), # neighborhood conditions 
  ncol = 3
) +
  plot_annotation(tag_levels = "a") +
  plot_layout(guides = "collect")

```

```{r}
  filter(!str_detect(term, "(Intercept)")) %>%
  mutate(term = case_when(
    term == "HCOST" ~ "Housing cost burden among households", 
    term == "POV150" ~ "Persons living below 150% of the poverty level",
    term == "CROWD" ~ "Crowding among housing units",
    term == "AGE65" ~ "Persons aged 65 years or older",     
    term == "SNGPNT" ~ "Single-parent households",
    term == "BROAD" ~ "No broadband internet subscription among households",
    term == "NOHSDP" ~ "No high school diploma among adults aged 25 years or older",
    term == "UNEMP" ~ "Unemployment among people 16 years and older in the labor force",
    term == "REMNRTY" ~ "Persons of racial or ethnic minority status"
  )) %>%
  ggplot(aes(x = term)) +
  geom_text_repel(aes(y = estimate, label = round(estimate, 2), size = 1.5),
    position = position_dodge(width = 0.9),
    col = "black",
    show.legend = FALSE
  ) +
  geom_col(aes(x = fct_reorder(term, estimate), y = estimate), position = "dodge", alpha = 0.4) +
  geom_errorbar(aes(ymax = estimate + std.error, ymin = estimate - std.error), position = "dodge", alpha = 0.4) +
  geom_hline(yintercept = 0, linetype = "dashed", col = "red") +
  labs(
    x = "Predictors",
    y = "Estimated regression coefficient",
    fill = "Response variables"
  ) +
  scale_fill_viridis_d(begin = 0.1, end = 0.9) +
  # facet_wrap(~term, ncol = 2) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  coord_flip() +
  theme(legend.position = "bottom")
```